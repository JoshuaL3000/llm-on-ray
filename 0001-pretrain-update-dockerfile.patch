From 10082448a5954ff1e57d80803e219dc2a8595623 Mon Sep 17 00:00:00 2001
From: zhangjian <jian2.zhang@intel.com>
Date: Tue, 31 Oct 2023 15:21:51 +0000
Subject: [PATCH] [pretrain] update dockerfile

---
 ..._pretrain_template.conf => pretrain_template.conf} |  0
 ...e.conf => pretrain_template_megatron_dataset.conf} |  0
 tools/workload_in_containers/Dockerfile.megatron.gpu  | 11 +++++------
 .../workload_in_containers/Dockerfile.megatron.habana |  1 -
 4 files changed, 5 insertions(+), 7 deletions(-)
 rename pretrain/{llm_pretrain_template.conf => pretrain_template.conf} (100%)
 rename pretrain/{megatron_pretrain_template.conf => pretrain_template_megatron_dataset.conf} (100%)

diff --git a/pretrain/llm_pretrain_template.conf b/pretrain/pretrain_template.conf
similarity index 100%
rename from pretrain/llm_pretrain_template.conf
rename to pretrain/pretrain_template.conf
diff --git a/pretrain/megatron_pretrain_template.conf b/pretrain/pretrain_template_megatron_dataset.conf
similarity index 100%
rename from pretrain/megatron_pretrain_template.conf
rename to pretrain/pretrain_template_megatron_dataset.conf
diff --git a/tools/workload_in_containers/Dockerfile.megatron.gpu b/tools/workload_in_containers/Dockerfile.megatron.gpu
index 1931841..2a00542 100644
--- a/tools/workload_in_containers/Dockerfile.megatron.gpu
+++ b/tools/workload_in_containers/Dockerfile.megatron.gpu
@@ -4,16 +4,15 @@ ENV DEBIAN_FRONTEND=noninteractive
 WORKDIR /home/user
 
 COPY requirements.txt /home/user/
-COPY pretrain/patch/gpu/0001-workaround-and-hot-fix-for-llm-ray.patch /home/user/
+COPY pretrain/patch/gpu/0001-hot-fix-for-megatron-deepspeed.patch /home/user/
 RUN pip install -r requirements.txt
 RUN pip install deepspeed lz4
 RUN pip install -U numpy
 ENV MAX_JOBS=32
-RUN git clone https://github.com/microsoft/Megatron-DeepSpeed.git && \
-    cd Megatron-DeepSpeed && \
-    git checkout 319c9b1c9acd97016aa3f7b86f81b16b17bd61fe && \
-    git am ../0001-workaround-and-hot-fix-for-llm-ray.patch && \
-    pip install -e .
+RUN cd src/megatron-core && \
+    git am ../0001-hot-fix-for-megatron-deepspeed.patch && \
+RUN git config --global user.email "root@example.com" 
+RUN git config --global user.name "root" 
 RUN git clone https://github.com/NVIDIA/apex && \
     cd apex && \
     git checkout 22.04-dev &&\
diff --git a/tools/workload_in_containers/Dockerfile.megatron.habana b/tools/workload_in_containers/Dockerfile.megatron.habana
index 43f03d6..6fe7f4c 100644
--- a/tools/workload_in_containers/Dockerfile.megatron.habana
+++ b/tools/workload_in_containers/Dockerfile.megatron.habana
@@ -3,7 +3,6 @@ ENV DEBIAN_FRONTEND=noninteractive
 WORKDIR /home/user
 RUN pip install lz4 numpy==1.24.4 ray==2.5.0 tensorboard gpustat==1.0.0 sentencepiece accelerate==0.19.0 raydp==1.6.0b20230527.dev0 datasets==2.12.0 gymnasium transformers==4.26.0 dm-tree scikit-image
 RUN pip install git+https://github.com/HabanaAI/DeepSpeed.git@1.11.0
-COPY pretrain/patch/hpu/config.py /usr/local/lib/python3.8/dist-packages/ray/train/torch/
 COPY pretrain/patch/hpu/0001-Init-megatron-deepspeed-with-Ray-cluster.patch .
 RUN git config --global user.email "root@example.com" 
 RUN git config --global user.name "root" 
-- 
2.25.1

