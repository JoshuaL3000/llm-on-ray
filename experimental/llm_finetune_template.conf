# I am python, not json
{
    #"run_mode" : "ray",
    "run_mode" : "standalone",
    "seed": 42,
    "torch_thread_num": 56,
    "logging_config_file": "/panfs/users/liangyul/workspace/llm-ray/experimental/logging.conf",
    "logger_name": "custom",
    "accelerator": {
        "gradient_accumulation_steps": 1,
    },
    "datasets": {
        "type": "HuggingfaceDataset",
        "name": "/panfs/users/liangyul/workspace/llm-ray/data/huggingface/wikitext-2-raw",
        "load_from_disk": True,
        "load_config" : {}
    },
    "tokenizer": {
        "type": "HuggingFaceTokenizer",
        "name": "/panfs/users/liangyul/workspace/llm-ray/tokenizer/EleutherAI/gpt-j-6B",
        # "name": "/panfs/users/liangyul/workspace/llm-ray/tokenizer/EleutherAI/pythia-2.8b",
        # "name": "/panfs/users/liangyul/workspace/llm-ray/tokenizer/bigscience/bloom-560m",
        # "name": "/panfs/users/liangyul/workspace/llm-ray/tokenizer/facebook/opt-125m",
        "config": {}
    },
    "model": {
        "type": "HuggingFaceModelForCausalLM",
        "name": "/panfs/users/liangyul/workspace/llm-ray/model/EleutherAI/gpt-j-6B",
        # "name": "/panfs/users/liangyul/workspace/llm-ray/model/EleutherAI/pythia-2.8b",
        # "name": "/panfs/users/liangyul/workspace/llm-ray/model/bigscience/bloom-560m",
        # "name": "/panfs/users/liangyul/workspace/llm-ray/model/facebook/opt-125m",
        "config": {}
    },
    "optimizer": {
        "type": "DefaultOptimizer",
        "name": "AdamW",
        "config": {
            "lr" : 1e-5,
        }
    },
    "trainer": {
        "type": "DefaultTrainer",
        "dataprocesser": {
            "type": "WikitextProcesser",
            "preprocessing_num_workers": 4,
            "batched": True,
            "batch_size": 1000,
            "block_size": 1024,
            "overwrite_cache": True,
            "per_device_train_batch_size": 4,
            "per_device_eval_batch_size": 4,
            "shuffle": False
        },
        "lr_scheduler": {
            "enable": False,
            "max_train_steps": None,
            "lr_scheduler_type": "linear",
            "num_warmup_steps": 0,
        },
        "checkpoint": {

        }
    },
    "ray_config": {
        "init": {
            "runtime_env": {
                "env_vars": {
                    "OMP_NUM_THREADS": "56", 
                    "ACCELERATE_USE_CPU": "True", 
                    "ACCELERATE_USE_FSDP": "true",  # FSDP setting
                    "FSDP_SHARDING_STRATEGY": "1", 
                    "FSDP_OFFLOAD_PARAMS": "false", 
                    "FSDP_MIN_NUM_PARAMS": "1000000", 
                    "FSDP_AUTO_WRAP_POLICY": "SIZE_BASED_WRAP", 
                    "FSDP_BACKWARD_PREFETCH": "BACKWARD_PRE", 
                    "FSDP_STATE_DICT_TYPE": "SHARDED_STATE_DICT", 
                    "ACCELERATE_MIXED_PRECISION": "no",
                    "CCL_WORKER_COUNT": "1",        # CCL setting
                    "CCL_LOG_LEVEL": "info",
                    "WORLD_SIZE": "2",    # Enable multi-process
                    #"FI_PROVIDER": "tcp",         # Network setting
                    #"FI_PROVIDER": "psm3",         # Network setting
                    "FI_TCP_IFACE": "eib0",
                    "LD_LIBRARY_PATH": "/usr/local/ofed/mlnx-5.9-0.5.6.0_372.32.1.3_2.12.9/lib64:/usr/local/ofed/mlnx-5.9-0.5.6.0_372.32.1.3_2.12.9/lib64/libibverbs",
                    "KMP_AFFINITY": "granularity=fine,compact",
                    #"FI_TCP_IFACE": "lo",
                    #"FI_TCP_IFACE": "eth0",
                    #"JAVA_HOME": os.getenv("JAVA_HOME"),
                    #"CLASSPATH": os.getenv("CLASSPATH"),
                    #"ARROW_LIBHDFS_DIR": os.getenv("ARROW_LIBHDFS_DIR"),
                    #"RAY_PDB" : "0"
                }
            },
            #"num_cpus": 56,
            "address": "auto",
            "_node_ip_address": "127.0.0.1",
        },
        "scaling_config": {
            "num_workers": 2,
            "resources_per_worker": {
                "CPU": 56
            },
            "placement_strategy": "SPREAD"
        },
        "torch_config": {
            "backend" : "ccl",
        },
        "failure_config": {
            "max_failures": 5
        },
        "run_config": {
            "local_dir": "."
        }
    }
}
